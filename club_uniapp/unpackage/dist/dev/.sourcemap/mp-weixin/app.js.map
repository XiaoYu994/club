{"version":3,"file":"app.js","sources":["App.vue","main.js"],"sourcesContent":["<script>\r\nimport wsClient from '@/utils/websocket'\r\nimport apiModule from '@/api/api.js'\r\nimport { showNotification } from '@/utils/notification.js'\r\n\r\nexport default {\r\n  onLaunch: function() {\r\n    console.warn('当前组件仅支持 uni_modules 目录结构 ,请升级 HBuilderX 到 3.1.0 版本以上！')\r\n    console.log('【App】应用启动')\r\n\r\n    // 检查是否已登录，如果已登录则建立WebSocket连接\r\n    const token = uni.getStorageSync('token')\r\n    if (token) {\r\n      console.log('【App】检测到用户已登录，Token:', token.substring(0, 20) + '...')\r\n      console.log('【App】服务器地址:', apiModule.baseURL)\r\n      console.log('【App】开始建立WebSocket连接')\r\n\r\n      wsClient.connect(apiModule.baseURL || 'http://localhost:8081')\r\n        .then(() => {\r\n          console.log('【App】WebSocket连接成功')\r\n        })\r\n        .catch((error) => {\r\n          console.error('【App】WebSocket连接失败:', error)\r\n          console.error('【App】错误详情:', JSON.stringify(error))\r\n        })\r\n    } else {\r\n      console.log('【App】用户未登录，跳过WebSocket连接')\r\n    }\r\n\r\n    // 注册全局消息通知处理器\r\n    this.registerGlobalNotificationHandlers()\r\n  },\r\n  onShow: function() {\r\n    console.log('【App】应用显示')\r\n\r\n    // 检查是否已登录，确保全局通知处理器始终注册\r\n    const token = uni.getStorageSync('token')\r\n    if (token && wsClient.isConnected) {\r\n      // 重新注册全局处理器（防御性措施，避免被其他页面清除）\r\n      this.registerGlobalNotificationHandlers()\r\n    }\r\n  },\r\n  onHide: function() {\r\n    console.log('App Hide')\r\n  },\r\n  methods: {\r\n    /**\r\n     * 注册全局消息通知处理器\r\n     */\r\n    registerGlobalNotificationHandlers() {\r\n      console.log('【App】开始注册全局通知处理器')\r\n\r\n      // 统一的通知处理函数\r\n      const handleNotification = (message) => {\r\n        console.log('【通知】收到通知消息:', message)\r\n\r\n        // 验证必需字段\r\n        if (!message.type || !message.title || !message.message) {\r\n          console.error('【通知】消息格式不正确，缺少必需字段:', message)\r\n          return\r\n        }\r\n\r\n        // 直接使用后端传来的数据显示通知\r\n        showNotification({\r\n          type: message.type.replace('_notification', ''), // 移除后缀得到纯类型\r\n          title: message.title,\r\n          message: message.message,\r\n          extraInfo: message.extraInfo || message.feedback || null\r\n        })\r\n\r\n        // 触发对应的全局事件（供其他页面监听）\r\n        this.emitNotificationEvent(message)\r\n      }\r\n\r\n      // 注册所有通知类型到统一处理函数\r\n      const notificationTypes = [\r\n        'activity_cancel_notification',\r\n        'apply_approved_notification',\r\n        'apply_rejected_notification',\r\n        'activity_reminder_notification'\r\n      ]\r\n\r\n      notificationTypes.forEach(type => {\r\n        wsClient.onMessageType(type, handleNotification)\r\n        console.log(`【App】已注册通知类型: ${type}`)\r\n      })\r\n\r\n      console.log('【App】全局通知处理器注册完成')\r\n    },\r\n\r\n    // 触发全局事件（供其他页面监听状态变化）\r\n    emitNotificationEvent(message) {\r\n      const type = message.type\r\n\r\n      if (type === 'activity_cancel_notification') {\r\n        uni.$emit('activityCancelled', {\r\n          activityId: message.activityId,\r\n          activityTitle: message.activityTitle\r\n        })\r\n      } else if (type === 'apply_approved_notification' || type === 'apply_rejected_notification') {\r\n        uni.$emit('applyStatusChanged', {\r\n          activityId: message.activityId,\r\n          applyId: message.applyId,\r\n          status: type === 'apply_approved_notification' ? 'approved' : 'rejected'\r\n        })\r\n      } else if (type === 'activity_reminder_notification') {\r\n        uni.$emit('activityReminder', {\r\n          activityId: message.activityId,\r\n          activityTitle: message.activityTitle\r\n        })\r\n      }\r\n    }\r\n  }\r\n}\r\n</script>\r\n\r\n<style lang=\"scss\">\r\n\t/*每个页面公共css */\r\n\t@import '@/uni_modules/uni-scss/index.scss';\r\n\t/* #ifndef APP-NVUE */\r\n\t@import '@/static/customicons.css';\r\n\t@import '@/common/style/common-style.scss';\r\n\r\n\t// 设置整个项目的背景色\r\n\tpage {\r\n\t\tbackground-color: #f5f5f5;\r\n\t}\r\n\r\n\t/* #endif */\r\n\t.example-info {\r\n\t\tfont-size: 14px;\r\n\t\tcolor: #333;\r\n\t\tpadding: 10px;\r\n\t}\r\n</style>\r\n","\r\n// #ifndef VUE3\r\nimport Vue from 'vue'\r\nimport App from './App'\r\nimport notificationPlugin from './utils/notification.js'\r\n\r\nVue.config.productionTip = false\r\n\r\n// 注册全局通知插件\r\nVue.use(notificationPlugin)\r\n\r\nApp.mpType = 'app'\r\n\r\nconst app = new Vue({\r\n    ...App\r\n})\r\napp.$mount()\r\n// #endif\r\n\r\n// #ifdef VUE3\r\nimport { createSSRApp } from 'vue'\r\nimport App from './App.vue'\r\nimport api from './api/api.js'\r\nimport notificationPlugin from './utils/notification.js'\r\n\r\nexport function createApp() {\r\n  const app = createSSRApp(App)\r\n  app.config.globalProperties.$api = api;\r\n\r\n  // 注册全局通知插件\r\n  app.use(notificationPlugin)\r\n\r\n  return {\r\n    app\r\n  }\r\n}\r\n// #endif"],"names":["uni","apiModule","wsClient","showNotification","createSSRApp","App","api","notificationPlugin"],"mappings":"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"}