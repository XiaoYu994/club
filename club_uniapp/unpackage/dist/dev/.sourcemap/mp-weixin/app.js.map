{"version":3,"file":"app.js","sources":["App.vue","main.js"],"sourcesContent":["<script>\r\nimport wsClient from '@/utils/websocket'\r\nimport apiModule from '@/api/api.js'\r\nimport { showNotification } from '@/utils/notification.js'\r\n\r\nexport default {\r\n  onLaunch: function() {\r\n    console.warn('当前组件仅支持 uni_modules 目录结构 ,请升级 HBuilderX 到 3.1.0 版本以上！')\r\n    console.log('【App】应用启动')\r\n\r\n    // 检查是否已登录，如果已登录则建立WebSocket连接\r\n    const token = uni.getStorageSync('token')\r\n    if (token) {\r\n      console.log('【App】检测到用户已登录，Token:', token.substring(0, 20) + '...')\r\n      console.log('【App】服务器地址:', apiModule.baseURL)\r\n      console.log('【App】开始建立WebSocket连接')\r\n\r\n      wsClient.connect(apiModule.baseURL || 'http://localhost:8081')\r\n        .then(() => {\r\n          console.log('【App】WebSocket连接成功')\r\n        })\r\n        .catch((error) => {\r\n          console.error('【App】WebSocket连接失败:', error)\r\n          console.error('【App】错误详情:', JSON.stringify(error))\r\n        })\r\n\r\n      // 加载未读消息数量并显示tabBar红点\r\n      this.loadUnreadCountAndUpdateBadge()\r\n    } else {\r\n      console.log('【App】用户未登录，跳过WebSocket连接')\r\n    }\r\n\r\n    // 注册全局消息通知处理器\r\n    this.registerGlobalNotificationHandlers()\r\n  },\r\n  onShow: function() {\r\n    console.log('【App】应用显示')\r\n\r\n    // 检查是否已登录，确保全局通知处理器始终注册\r\n    const token = uni.getStorageSync('token')\r\n    if (token && wsClient.isConnected) {\r\n      // 重新注册全局处理器（防御性措施，避免被其他页面清除）\r\n      this.registerGlobalNotificationHandlers()\r\n\r\n      // 刷新未读消息数量\r\n      this.loadUnreadCountAndUpdateBadge()\r\n    }\r\n  },\r\n  onHide: function() {\r\n    console.log('App Hide')\r\n  },\r\n  methods: {\r\n    /**\r\n     * 加载未读消息数量并更新tabBar红点\r\n     */\r\n    async loadUnreadCountAndUpdateBadge() {\r\n      try {\r\n        console.log('【App】开始加载未读消息数量')\r\n        const response = await apiModule.notification.getUnreadCount()\r\n\r\n        if (response.code === 200) {\r\n          const unreadCount = response.data || 0\r\n          console.log('【App】未读消息数量:', unreadCount)\r\n\r\n          // 更新tabBar红点\r\n          if (unreadCount > 0) {\r\n            const badgeText = unreadCount > 99 ? '99+' : String(unreadCount)\r\n            uni.setTabBarBadge({\r\n              index: 3,\r\n              text: badgeText\r\n            })\r\n            console.log('【App】已设置tabBar红点:', badgeText)\r\n          } else {\r\n            uni.removeTabBarBadge({ index: 3 })\r\n            console.log('【App】已移除tabBar红点')\r\n          }\r\n        } else {\r\n          console.error('【App】获取未读消息数量失败:', response.message)\r\n        }\r\n      } catch (error) {\r\n        console.error('【App】加载未读消息数量异常:', error)\r\n      }\r\n    },\r\n\r\n    /**\r\n     * 注册全局消息通知处理器\r\n     */\r\n    registerGlobalNotificationHandlers() {\r\n      console.log('【App】开始注册全局通知处理器')\r\n\r\n      // 统一的通知处理函数\r\n      const handleNotification = (message) => {\r\n        console.log('【通知】收到通知消息:', message)\r\n\r\n        // 验证必需字段\r\n        if (!message.type || !message.title || !message.message) {\r\n          console.error('【通知】消息格式不正确，缺少必需字段:', message)\r\n          return\r\n        }\r\n\r\n        // 直接使用后端传来的数据显示通知\r\n        showNotification({\r\n          type: message.type.replace('_notification', ''), // 移除后缀得到纯类型\r\n          title: message.title,\r\n          message: message.message,\r\n          extraInfo: message.extraInfo || message.feedback || null\r\n        })\r\n\r\n        // 更新tabBar红点（收到新消息时，未读数+1）\r\n        this.updateTabBarBadgeOnNewMessage()\r\n\r\n        // 触发对应的全局事件（供其他页面监听）\r\n        this.emitNotificationEvent(message)\r\n      }\r\n\r\n      // 注册所有通知类型到统一处理函数\r\n      const notificationTypes = [\r\n        'activity_cancel_notification',        // 活动取消通知\r\n        'apply_approved_notification',         // 活动报名审核通过\r\n        'apply_rejected_notification',         // 活动报名审核拒绝\r\n        'activity_reminder_notification',      // 活动提醒\r\n        'check_in_notification',               // 签到成功通知\r\n        'club_apply_approved_notification',    // 社团申请审核通过\r\n        'club_apply_rejected_notification',    // 社团申请审核拒绝\r\n        'club_member_removed_notification',    // 社团成员被移除\r\n        'club_quit_apply_notification',        // 退社申请（通知管理员）\r\n        'club_quit_approved_notification',     // 退社申请通过（通知用户）\r\n        'club_quit_rejected_notification',     // 退社申请拒绝（通知用户）\r\n        'system_broadcast_notification',       // 系统广播通知\r\n        'admin_notification_notification',    // 管理员通知\r\n        'admin_message_notification'           // 管理员指定消息\r\n      ]\r\n\r\n      notificationTypes.forEach(type => {\r\n        wsClient.onMessageType(type, handleNotification)\r\n        console.log(`【App】已注册通知类型: ${type}`)\r\n      })\r\n\r\n      console.log('【App】全局通知处理器注册完成')\r\n    },\r\n\r\n    // 触发全局事件（供其他页面监听状态变化）\r\n    emitNotificationEvent(message) {\r\n      const type = message.type\r\n\r\n      if (type === 'activity_cancel_notification') {\r\n        uni.$emit('activityCancelled', {\r\n          activityId: message.activityId,\r\n          activityTitle: message.activityTitle\r\n        })\r\n      } else if (type === 'apply_approved_notification' || type === 'apply_rejected_notification') {\r\n        uni.$emit('applyStatusChanged', {\r\n          activityId: message.activityId,\r\n          applyId: message.applyId,\r\n          status: type === 'apply_approved_notification' ? 'approved' : 'rejected'\r\n        })\r\n      } else if (type === 'club_apply_approved_notification' || type === 'club_apply_rejected_notification') {\r\n        // 社团申请审核结果事件\r\n        uni.$emit('clubApplyStatusChanged', {\r\n          clubId: message.clubId,\r\n          clubName: message.clubName,\r\n          applyId: message.applyId,\r\n          status: type === 'club_apply_approved_notification' ? 'approved' : 'rejected'\r\n        })\r\n      } else if (type === 'club_member_removed_notification') {\r\n        // 社团成员被移除事件\r\n        uni.$emit('clubMemberRemoved', {\r\n          clubId: message.clubId,\r\n          clubName: message.clubName\r\n        })\r\n      } else if (type === 'club_quit_apply_notification') {\r\n        // 退社申请事件（管理员收到）\r\n        uni.$emit('clubQuitApply', {\r\n          clubId: message.clubId,\r\n          clubName: message.clubName,\r\n          applicantUserId: message.applicantUserId,\r\n          applicantName: message.applicantName\r\n        })\r\n      } else if (type === 'club_quit_approved_notification') {\r\n        // 退社申请通过事件\r\n        uni.$emit('clubQuitApproved', {\r\n          clubId: message.clubId,\r\n          clubName: message.clubName\r\n        })\r\n      } else if (type === 'club_quit_rejected_notification') {\r\n        // 退社申请拒绝事件\r\n        uni.$emit('clubQuitRejected', {\r\n          clubId: message.clubId,\r\n          clubName: message.clubName\r\n        })\r\n      } else if (type === 'activity_reminder_notification') {\r\n        uni.$emit('activityReminder', {\r\n          activityId: message.activityId,\r\n          activityTitle: message.activityTitle\r\n        })\r\n      } else if (type === 'check_in_notification') {\r\n        // 签到成功事件\r\n        uni.$emit('checkInSuccess', {\r\n          activityId: message.activityId,\r\n          activityTitle: message.activityTitle\r\n        })\r\n      } else if (type === 'system_broadcast_notification') {\r\n        // 系统广播事件\r\n        uni.$emit('systemBroadcast', {\r\n          title: message.title,\r\n          message: message.message\r\n        })\r\n      } else if (type === 'admin_notification_notification') {\r\n        // 管理员通知事件\r\n        uni.$emit('adminNotification', {\r\n          title: message.title,\r\n          message: message.message\r\n        })\r\n      }\r\n    },\r\n\r\n    // 收到新消息时更新tabBar红点\r\n    updateTabBarBadgeOnNewMessage() {\r\n      try {\r\n        // 获取当前显示的徽章文本\r\n        uni.getTabBarBadge({\r\n          index: 3,\r\n          success: (res) => {\r\n            let currentCount = 0\r\n            if (res.text) {\r\n              // 如果显示的是99+，则保持99+\r\n              if (res.text === '99+') {\r\n                return\r\n              }\r\n              currentCount = parseInt(res.text) || 0\r\n            }\r\n            // 新消息数+1\r\n            const newCount = currentCount + 1\r\n            const badgeText = newCount > 99 ? '99+' : String(newCount)\r\n            uni.setTabBarBadge({\r\n              index: 3,\r\n              text: badgeText\r\n            })\r\n            console.log('【TabBar】更新红点数量:', badgeText)\r\n          },\r\n          fail: () => {\r\n            // 如果没有徽章，则设置为1\r\n            uni.setTabBarBadge({\r\n              index: 3,\r\n              text: '1'\r\n            })\r\n            console.log('【TabBar】设置红点数量: 1')\r\n          }\r\n        })\r\n      } catch (error) {\r\n        console.error('【TabBar】更新红点失败:', error)\r\n      }\r\n    }\r\n  }\r\n}\r\n</script>\r\n\r\n<style lang=\"scss\">\r\n\t/*每个页面公共css */\r\n\t@import '@/uni_modules/uni-scss/index.scss';\r\n\t/* #ifndef APP-NVUE */\r\n\t@import '@/static/customicons.css';\r\n\t@import '@/common/style/common-style.scss';\r\n\r\n\t// 设置整个项目的背景色\r\n\tpage {\r\n\t\tbackground-color: #f5f5f5;\r\n\t}\r\n\r\n\t/* #endif */\r\n\t.example-info {\r\n\t\tfont-size: 14px;\r\n\t\tcolor: #333;\r\n\t\tpadding: 10px;\r\n\t}\r\n</style>\r\n","\r\n// #ifndef VUE3\r\nimport Vue from 'vue'\r\nimport App from './App'\r\nimport notificationPlugin from './utils/notification.js'\r\n\r\nVue.config.productionTip = false\r\n\r\n// 注册全局通知插件\r\nVue.use(notificationPlugin)\r\n\r\nApp.mpType = 'app'\r\n\r\nconst app = new Vue({\r\n    ...App\r\n})\r\napp.$mount()\r\n// #endif\r\n\r\n// #ifdef VUE3\r\nimport { createSSRApp } from 'vue'\r\nimport App from './App.vue'\r\nimport api from './api/api.js'\r\nimport notificationPlugin from './utils/notification.js'\r\n\r\nexport function createApp() {\r\n  const app = createSSRApp(App)\r\n  app.config.globalProperties.$api = api;\r\n\r\n  // 注册全局通知插件\r\n  app.use(notificationPlugin)\r\n\r\n  return {\r\n    app\r\n  }\r\n}\r\n// #endif"],"names":["uni","apiModule","wsClient","showNotification","createSSRApp","App","api","notificationPlugin"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAKA,MAAK,YAAU;AAAA,EACb,UAAU,WAAW;AACnBA,kBAAAA,MAAA,MAAA,QAAA,gBAAa,uDAAuD;AACpEA,kBAAAA,MAAY,MAAA,OAAA,gBAAA,WAAW;AAGvB,UAAM,QAAQA,cAAAA,MAAI,eAAe,OAAO;AACxC,QAAI,OAAO;AACTA,oBAAAA,MAAA,MAAA,OAAA,iBAAY,wBAAwB,MAAM,UAAU,GAAG,EAAE,IAAI,KAAK;AAClEA,wDAAY,eAAeC,QAAS,UAAC,OAAO;AAC5CD,oBAAAA,MAAA,MAAA,OAAA,iBAAY,sBAAsB;AAElCE,sBAAAA,SAAS,QAAQD,kBAAU,WAAW,uBAAuB,EAC1D,KAAK,MAAM;AACVD,sBAAAA,MAAA,MAAA,OAAA,iBAAY,oBAAoB;AAAA,OACjC,EACA,MAAM,CAAC,UAAU;AAChBA,sBAAAA,MAAA,MAAA,SAAA,iBAAc,uBAAuB,KAAK;AAC1CA,4BAAA,MAAA,SAAA,iBAAc,cAAc,KAAK,UAAU,KAAK,CAAC;AAAA,OAClD;AAGH,WAAK,8BAA8B;AAAA,WAC9B;AACLA,oBAAAA,MAAY,MAAA,OAAA,iBAAA,0BAA0B;AAAA,IACxC;AAGA,SAAK,mCAAmC;AAAA,EACzC;AAAA,EACD,QAAQ,WAAW;AACjBA,kBAAAA,MAAY,MAAA,OAAA,iBAAA,WAAW;AAGvB,UAAM,QAAQA,cAAAA,MAAI,eAAe,OAAO;AACxC,QAAI,SAASE,gBAAQ,SAAC,aAAa;AAEjC,WAAK,mCAAmC;AAGxC,WAAK,8BAA8B;AAAA,IACrC;AAAA,EACD;AAAA,EACD,QAAQ,WAAW;AACjBF,kBAAAA,MAAA,MAAA,OAAA,iBAAY,UAAU;AAAA,EACvB;AAAA,EACD,SAAS;AAAA;AAAA;AAAA;AAAA,IAIP,MAAM,gCAAgC;AACpC,UAAI;AACFA,sBAAAA,MAAY,MAAA,OAAA,iBAAA,iBAAiB;AAC7B,cAAM,WAAW,MAAMC,kBAAU,aAAa,eAAe;AAE7D,YAAI,SAAS,SAAS,KAAK;AACzB,gBAAM,cAAc,SAAS,QAAQ;AACrCD,wBAAAA,MAAA,MAAA,OAAA,iBAAY,gBAAgB,WAAW;AAGvC,cAAI,cAAc,GAAG;AACnB,kBAAM,YAAY,cAAc,KAAK,QAAQ,OAAO,WAAW;AAC/DA,0BAAAA,MAAI,eAAe;AAAA,cACjB,OAAO;AAAA,cACP,MAAM;AAAA,aACP;AACDA,0BAAAA,MAAA,MAAA,OAAA,iBAAY,qBAAqB,SAAS;AAAA,iBACrC;AACLA,0BAAAA,MAAI,kBAAkB,EAAE,OAAO,GAAG;AAClCA,0BAAAA,MAAA,MAAA,OAAA,iBAAY,kBAAkB;AAAA,UAChC;AAAA,eACK;AACLA,wBAAA,MAAA,MAAA,SAAA,iBAAc,oBAAoB,SAAS,OAAO;AAAA,QACpD;AAAA,MACA,SAAO,OAAO;AACdA,sBAAAA,MAAc,MAAA,SAAA,iBAAA,oBAAoB,KAAK;AAAA,MACzC;AAAA,IACD;AAAA;AAAA;AAAA;AAAA,IAKD,qCAAqC;AACnCA,oBAAAA,oCAAY,kBAAkB;AAG9B,YAAM,qBAAqB,CAAC,YAAY;AACtCA,sBAAAA,MAAA,MAAA,OAAA,iBAAY,eAAe,OAAO;AAGlC,YAAI,CAAC,QAAQ,QAAQ,CAAC,QAAQ,SAAS,CAAC,QAAQ,SAAS;AACvDA,wBAAAA,MAAc,MAAA,SAAA,iBAAA,uBAAuB,OAAO;AAC5C;AAAA,QACF;AAGAG,4CAAiB;AAAA,UACf,MAAM,QAAQ,KAAK,QAAQ,iBAAiB,EAAE;AAAA;AAAA,UAC9C,OAAO,QAAQ;AAAA,UACf,SAAS,QAAQ;AAAA,UACjB,WAAW,QAAQ,aAAa,QAAQ,YAAY;AAAA,SACrD;AAGD,aAAK,8BAA8B;AAGnC,aAAK,sBAAsB,OAAO;AAAA,MACpC;AAGA,YAAM,oBAAoB;AAAA,QACxB;AAAA;AAAA,QACA;AAAA;AAAA,QACA;AAAA;AAAA,QACA;AAAA;AAAA,QACA;AAAA;AAAA,QACA;AAAA;AAAA,QACA;AAAA;AAAA,QACA;AAAA;AAAA,QACA;AAAA;AAAA,QACA;AAAA;AAAA,QACA;AAAA;AAAA,QACA;AAAA;AAAA,QACA;AAAA;AAAA,QACA;AAAA;AAAA,MACF;AAEA,wBAAkB,QAAQ,UAAQ;AAChCD,iCAAS,cAAc,MAAM,kBAAkB;AAC/CF,sBAAY,MAAA,MAAA,OAAA,kBAAA,iBAAiB,IAAI,EAAE;AAAA,OACpC;AAEDA,oBAAAA,qCAAY,kBAAkB;AAAA,IAC/B;AAAA;AAAA,IAGD,sBAAsB,SAAS;AAC7B,YAAM,OAAO,QAAQ;AAErB,UAAI,SAAS,gCAAgC;AAC3CA,sBAAG,MAAC,MAAM,qBAAqB;AAAA,UAC7B,YAAY,QAAQ;AAAA,UACpB,eAAe,QAAQ;AAAA,SACxB;AAAA,MACH,WAAW,SAAS,iCAAiC,SAAS,+BAA+B;AAC3FA,sBAAG,MAAC,MAAM,sBAAsB;AAAA,UAC9B,YAAY,QAAQ;AAAA,UACpB,SAAS,QAAQ;AAAA,UACjB,QAAQ,SAAS,gCAAgC,aAAa;AAAA,SAC/D;AAAA,MACH,WAAW,SAAS,sCAAsC,SAAS,oCAAoC;AAErGA,sBAAG,MAAC,MAAM,0BAA0B;AAAA,UAClC,QAAQ,QAAQ;AAAA,UAChB,UAAU,QAAQ;AAAA,UAClB,SAAS,QAAQ;AAAA,UACjB,QAAQ,SAAS,qCAAqC,aAAa;AAAA,SACpE;AAAA,iBACQ,SAAS,oCAAoC;AAEtDA,sBAAG,MAAC,MAAM,qBAAqB;AAAA,UAC7B,QAAQ,QAAQ;AAAA,UAChB,UAAU,QAAQ;AAAA,SACnB;AAAA,iBACQ,SAAS,gCAAgC;AAElDA,sBAAG,MAAC,MAAM,iBAAiB;AAAA,UACzB,QAAQ,QAAQ;AAAA,UAChB,UAAU,QAAQ;AAAA,UAClB,iBAAiB,QAAQ;AAAA,UACzB,eAAe,QAAQ;AAAA,SACxB;AAAA,iBACQ,SAAS,mCAAmC;AAErDA,sBAAG,MAAC,MAAM,oBAAoB;AAAA,UAC5B,QAAQ,QAAQ;AAAA,UAChB,UAAU,QAAQ;AAAA,SACnB;AAAA,iBACQ,SAAS,mCAAmC;AAErDA,sBAAG,MAAC,MAAM,oBAAoB;AAAA,UAC5B,QAAQ,QAAQ;AAAA,UAChB,UAAU,QAAQ;AAAA,SACnB;AAAA,iBACQ,SAAS,kCAAkC;AACpDA,sBAAG,MAAC,MAAM,oBAAoB;AAAA,UAC5B,YAAY,QAAQ;AAAA,UACpB,eAAe,QAAQ;AAAA,SACxB;AAAA,MACH,WAAW,SAAS,yBAAyB;AAE3CA,sBAAG,MAAC,MAAM,kBAAkB;AAAA,UAC1B,YAAY,QAAQ;AAAA,UACpB,eAAe,QAAQ;AAAA,SACxB;AAAA,iBACQ,SAAS,iCAAiC;AAEnDA,sBAAG,MAAC,MAAM,mBAAmB;AAAA,UAC3B,OAAO,QAAQ;AAAA,UACf,SAAS,QAAQ;AAAA,SAClB;AAAA,iBACQ,SAAS,mCAAmC;AAErDA,sBAAG,MAAC,MAAM,qBAAqB;AAAA,UAC7B,OAAO,QAAQ;AAAA,UACf,SAAS,QAAQ;AAAA,SAClB;AAAA,MACH;AAAA,IACD;AAAA;AAAA,IAGD,gCAAgC;AAC9B,UAAI;AAEFA,sBAAAA,MAAI,eAAe;AAAA,UACjB,OAAO;AAAA,UACP,SAAS,CAAC,QAAQ;AAChB,gBAAI,eAAe;AACnB,gBAAI,IAAI,MAAM;AAEZ,kBAAI,IAAI,SAAS,OAAO;AACtB;AAAA,cACF;AACA,6BAAe,SAAS,IAAI,IAAI,KAAK;AAAA,YACvC;AAEA,kBAAM,WAAW,eAAe;AAChC,kBAAM,YAAY,WAAW,KAAK,QAAQ,OAAO,QAAQ;AACzDA,0BAAAA,MAAI,eAAe;AAAA,cACjB,OAAO;AAAA,cACP,MAAM;AAAA,aACP;AACDA,0BAAAA,qCAAY,mBAAmB,SAAS;AAAA,UACzC;AAAA,UACD,MAAM,MAAM;AAEVA,0BAAAA,MAAI,eAAe;AAAA,cACjB,OAAO;AAAA,cACP,MAAM;AAAA,aACP;AACDA,0BAAAA,MAAY,MAAA,OAAA,kBAAA,mBAAmB;AAAA,UACjC;AAAA,SACD;AAAA,MACD,SAAO,OAAO;AACdA,sBAAAA,MAAc,MAAA,SAAA,kBAAA,mBAAmB,KAAK;AAAA,MACxC;AAAA,IACF;AAAA,EACF;AACF;ACrOO,SAAS,YAAY;AAC1B,QAAM,MAAMI,cAAY,aAACC,SAAG;AAC5B,MAAI,OAAO,iBAAiB,OAAOC,QAAAA;AAGnC,MAAI,IAAIC,qCAAkB;AAE1B,SAAO;AAAA,IACL;AAAA,EACD;AACH;;;"}