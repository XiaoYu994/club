{"version":3,"file":"request.js","sources":["utils/request.js"],"sourcesContent":["// utils/request.js\nimport { removeUser } from '@/utils/auth.js'\n\nclass Request {\n  constructor() {\n    // this.baseURL = 'http://localhost:8081'\n\tthis.baseURL = 'https://cecille-insertional-keva.ngrok-free.dev'\n    this.timeout = 30000 // 增加超时时间到30秒\n    this.header = {\n      'content-type': 'application/json',\n      'ngrok-skip-browser-warning': 'true'  // 跳过 ngrok 的浏览器警告页面\n    }\n  }\n\n  // 设置请求头\n  setHeader(header) {\n    this.header = Object.assign(this.header, header)\n    return this\n  }\n  \n  // 修正setConfig方法\n  setConfig(config) {\n    if (config.baseURL) {\n      this.baseURL = config.baseURL\n    }\n    if (config.timeout) {\n      this.timeout = config.timeout\n    }\n    if (config.header) {\n      this.header = Object.assign(this.header, config.header)\n    }\n    return this\n  }\n\n  // 获取完整URL（添加debug日志）\n  getUrl(url) {\n    if (url.startsWith('http')) {\n      return url\n    }\n    const fullUrl = this.baseURL + url\n    return fullUrl\n  }\n\n  // 发起请求的核心方法\n  request(options = {}) {\n    return new Promise((resolve, reject) => {\n      // 获取token\n      let token = null;\n      let headerKey = 'authentication';\n      \n      // 判断是否是admin路径，使用不同的token和header key\n      if (options.url.startsWith('/admin')) {\n        token = uni.getStorageSync('adminToken');\n        headerKey = 'token'; // 管理员token的header key\n      } else {\n        token = uni.getStorageSync('token');\n      }\n      \n      if (token) {\n        this.header[headerKey] = `Bearer ${token}`;\n      }\n\n      uni.request({\n        url: this.getUrl(options.url),\n        method: options.method || 'GET',\n        data: options.data,\n        header: this.header,\n        timeout: this.timeout,\n        success: (res) => {\n          // 打印请求详情（调试用）\n          console.log('【请求】URL:', this.getUrl(options.url))\n          console.log('【请求】Method:', options.method || 'GET')\n          console.log('【请求】Headers:', this.header)\n          console.log('【响应】Status:', res.statusCode)\n          console.log('【响应】Data类型:', typeof res.data)\n\n          // 检查是否返回了 HTML（ngrok 确认页面）\n          if (typeof res.data === 'string' && res.data.includes('<!DOCTYPE html>')) {\n            console.error('【错误】收到 HTML 响应，可能是 ngrok 确认页面')\n            console.error('【错误】响应内容:', res.data.substring(0, 200))\n            uni.showToast({\n              title: '网络配置错误，请检查 ngrok 设置',\n              icon: 'none',\n              duration: 3000\n            })\n            reject({\n              code: -1,\n              message: '收到 HTML 响应而不是 JSON，请检查请求头配置'\n            })\n            return\n          }\n\n          // 根据HTTP状态码处理\n          if (res.statusCode >= 200 && res.statusCode < 300) {\n            // HTTP请求成功，但需要检查业务状态码\n            if (res.data && res.data.code !== undefined) {\n              // 业务状态码为200表示成功\n              if (res.data.code === 200) {\n                resolve(res.data)\n              } else {\n                // 业务状态码非200，显示错误提示\n                // 使用 setTimeout 确保 loading 已关闭，toast 能正常显示\n                setTimeout(() => {\n                  uni.showToast({\n                    title: res.data.message || '操作失败',\n                    icon: 'none',\n                    duration: 2500\n                  })\n                }, 100)\n                reject(res.data)\n              }\n            } else {\n              // 没有业务状态码，直接返回\n              resolve(res.data)\n            }\n          } else if (res.statusCode === 401) {\n            // 未授权，需要登录\n            // 判断是否是管理员路径\n            if (options.url.startsWith('/admin')) {\n              uni.showToast({\n                title: '管理员登录已过期，请重新登录',\n                icon: 'none'\n              })\n              // 清除管理员token\n              uni.removeStorageSync('adminToken')\n              uni.removeStorageSync('adminInfo')\n              // 跳转到管理员登录页\n              setTimeout(() => {\n                uni.navigateTo({\n                  url: '/pages/admin/login'\n                })\n              }, 1500)\n            } else {\n              // 普通用户登录过期处理\n              uni.showToast({\n                title: '登录已过期，请重新登录',\n                icon: 'none'\n              })\n              // 清除token\n              uni.removeStorageSync('token')\n              // 同步清除本地用户信息\n              try {\n                removeUser()\n              } catch (e) { /* ignore */ }\n              // 跳转到登录页\n              setTimeout(() => {\n                uni.navigateTo({\n                  url: '/pages/user/login'\n                })\n              }, 1500)\n            }\n            reject(res)\n          } else {\n            // 其他HTTP错误\n            uni.showToast({\n              title: res.data?.message || '请求失败',\n              icon: 'none'\n            })\n            reject(res)\n          }\n        },\n        fail: (err) => {\n          uni.showToast({\n            title: '网络异常',\n            icon: 'none'\n          })\n          console.error('请求失败:', err)\n          reject(err)\n        }\n      })\n    })\n  }\n\n  // GET请求\n  get(url, params = {}) {\n    return this.request({\n      url: params ? `${url}${this.paramsToString(params)}` : url,\n      method: 'GET'\n    })\n  }\n\n  // POST请求\n  post(url, data = {}) {\n    return this.request({\n      url,\n      method: 'POST',\n      data\n    })\n  }\n\n  // PUT请求\n  put(url, data = {}) {\n    return this.request({\n      url,\n      method: 'PUT',\n      data\n    })\n  }\n\n  // DELETE请求\n  delete(url, data = {}) {\n    return this.request({\n      url,\n      method: 'DELETE',\n      data\n    })\n  }\n\n  // PATCH请求\n  patch(url, data = {}) {\n    return this.request({\n      url,\n      method: 'PATCH',\n      data\n    })\n  }\n\n  // 将参数转换为查询字符串\n  paramsToString(params) {\n    if (!params) return ''\n    return '?' + Object.keys(params)\n      .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)\n      .join('&')\n  }\n\n  // 文件上传\n  upload(url, filePath, formData = {}, name = 'file') {\n    return new Promise((resolve, reject) => {\n      // 根据URL判断使用哪个token\n      let token = null;\n      let headerKey = 'Authorization';\n      \n      if (url.startsWith('/admin')) {\n        token = uni.getStorageSync('adminToken');\n      } else {\n        token = uni.getStorageSync('token');\n      }\n      \n      const header = { ...this.header }\n      \n      if (token) {\n        header[headerKey] = `Bearer ${token}`\n      }\n      \n      uni.uploadFile({\n        url: this.getUrl(url),\n        filePath,\n        name,\n        formData,\n        header,\n        timeout: this.timeout,\n        success: (res) => {\n          if (res.statusCode >= 200 && res.statusCode < 300) {\n            // 上传文件返回的数据是字符串，需要转成JSON\n            let data = res.data\n            if (typeof data === 'string') {\n              try {\n                data = JSON.parse(data)\n              } catch (e) {\n                console.error('上传响应数据解析失败', e)\n              }\n            }\n            resolve(data)\n          } else {\n            uni.showToast({\n              title: '上传失败',\n              icon: 'none'\n            })\n            reject(res)\n          }\n        },\n        fail: (err) => {\n          uni.showToast({\n            title: '上传失败',\n            icon: 'none'\n          })\n          console.error('上传失败:', err)\n          reject(err)\n        }\n      })\n    })\n  }\n}\n\n// 导出实例\nexport default new Request()"],"names":["uni","removeUser"],"mappings":"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"}