{"version":3,"file":"login.js","sources":["pages/user/login.vue","../../../../../Software/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvdXNlci9sb2dpbi52dWU"],"sourcesContent":["<template>\n  <view class=\"login-page\">\n    <image class=\"logo\" src=\"/static/logo.png\" mode=\"aspectFit\"></image>\n    <view class=\"title\">校园社团管理小程序</view>\n    <view class=\"login-tip\">登录后使用更多功能</view>\n    \n    <view class=\"login-btns\">\n      <button class=\"wechat-login-btn\" @tap=\"showLoginModal\" open-type=\"getUserInfo\">\n        <image src=\"/static/images/wechat-icon.png\" mode=\"aspectFit\"></image>\n        一键登录\n      </button>\n      <button class=\"phone-login-btn\" @tap=\"phoneLogin\">手机号登录</button>\n    </view>\n    \n    <view class=\"agreement\">\n      <checkbox :checked=\"agreeProtocol\" @tap=\"agreeProtocol = !agreeProtocol\" />\n      <text>同意《服务协议》、《隐私协议》</text>\n    </view>\n    \n    <!-- 登录确认弹窗 -->\n    <view class=\"login-modal\" v-if=\"showModal\">\n      <view class=\"modal-content\">\n        <view class=\"modal-title\">登录需同意</view>\n        <view class=\"modal-links\">\n          <text class=\"link\">《服务协议》</text>\n          <text class=\"link\">《隐私协议》</text>\n        </view>\n        <view class=\"modal-buttons\">\n          <button class=\"cancel-btn\" @tap=\"cancelLogin\">不同意</button>\n          <button class=\"confirm-btn\" @tap=\"confirmLogin\">同意并登录</button>\n        </view>\n      </view>\n    </view>\n  </view>\n</template>\n\n<script setup>\nimport { ref, getCurrentInstance } from 'vue'\nimport { setUser } from '@/utils/auth.js'\nimport wsClient from '@/utils/websocket'\nimport apiModule from '@/api/api.js'\n\nconst { proxy } = getCurrentInstance()\nconst agreeProtocol = ref(false)\nconst showModal = ref(false)\n\n// 显示登录确认弹窗\nfunction showLoginModal() {\n  if (!agreeProtocol.value) {\n    uni.showToast({ title: '请先同意协议', icon: 'none' })\n    return\n  }\n  showModal.value = true\n}\n\n// 取消登录\nfunction cancelLogin() {\n  showModal.value = false\n}\n\n// 确认微信登录\nasync function confirmLogin() {\n  showModal.value = false\n  try {\n    // 获取微信登录code\n    const loginResult = await new Promise((resolve, reject) => {\n      uni.login({\n        success: (res) => {\n          resolve(res)\n        },\n        fail: (err) => {\n          reject(err)\n        }\n      })\n    })\n    \n    // 调用后端登录接口\n    if (loginResult && loginResult.code) {\n      console.log('微信登录code:', loginResult.code)\n      const res = await proxy.$api.user.wxLogin(loginResult.code)\n      \n      if (res.code === 200) {\n        // 保存token\n        uni.setStorageSync('token', res.data.token)\n        // 保存用户信息到本地缓存\n        setUser(res.data)\n\n        // 建立WebSocket连接\n        console.log('【登录】准备建立WebSocket连接')\n        wsClient.connect(apiModule.baseURL || 'http://localhost:8081')\n\n        // 显示登录成功提示\n        uni.showToast({\n          title: '登录成功',\n          icon: 'success'\n        })\n\n        // 登录成功后重新加载用户页面，确保状态更新\n        setTimeout(() => {\n          uni.reLaunch({ url: '/pages/user/user' })\n        }, 1500)\n      } \n    } else {\n      throw new Error('获取登录凭证失败')\n    }\n  } catch (error) {\n    console.error(\"登录失败\", error)\n    uni.showToast({ \n      title: '登录失败', \n      icon: 'none' \n    })\n  }\n}\n\n// 手机号登录\nasync function phoneLogin() {\n  if (!agreeProtocol.value) {\n    uni.showToast({ title: '请先同意协议', icon: 'none' })\n    return\n  }\n  // 跳转到手机号登录页面\n  // uni.navigateTo({ url: '/pages/user/phoneLogin' })\n  // 调用后端登录接口\n  const res = await proxy.$api.user.wxLogin(\"phoneLogin\");\n  console.log(res.data)\n  if (res.code === 200) {\n    // 保存token\n    uni.setStorageSync('token', res.data.token)\n    // 保存用户信息到本地缓存\n    setUser(res.data)\n    \n    // 显示登录成功提示\n    uni.showToast({\n      title: '登录成功',\n      icon: 'success'\n    })\n    \n    // 登录成功后重新加载用户页面，确保状态更新\n    setTimeout(() => {\n      uni.reLaunch({ url: '/pages/user/user' })\n    }, 1500)\n  } \n}\n</script>\n\n<style lang=\"scss\" scoped>\n.login-page {\n  min-height: 100vh;\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  padding-top: 100rpx;\n  background: #f5f6fa;\n  \n  .logo {\n    width: 140rpx;\n    height: 140rpx;\n    margin-bottom: 20rpx;\n  }\n  \n  .title {\n    font-size: 40rpx;\n    font-weight: bold;\n    color: #333;\n    margin-bottom: 16rpx;\n  }\n  \n  .login-tip {\n    font-size: 28rpx;\n    color: #888;\n    margin-bottom: 60rpx;\n  }\n  \n  .login-btns {\n    width: 80%;\n    margin-bottom: 30rpx;\n    \n    .wechat-login-btn {\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      background: #07c160;\n      color: #fff;\n      height: 88rpx;\n      border-radius: 44rpx;\n      margin-bottom: 20rpx;\n      \n      image {\n        width: 40rpx;\n        height: 40rpx;\n        margin-right: 10rpx;\n      }\n    }\n    \n    .phone-login-btn {\n      background: #f5f5f5;\n      color: #333;\n      height: 88rpx;\n      border-radius: 44rpx;\n      line-height: 88rpx;\n    }\n  }\n  \n  .agreement {\n    display: flex;\n    align-items: center;\n    font-size: 24rpx;\n    color: #888;\n    \n    checkbox {\n      transform: scale(0.7);\n      margin-right: 4rpx;\n    }\n  }\n}\n\n// 登录确认弹窗\n.login-modal {\n  position: fixed;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  background: rgba(0,0,0,0.5);\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  z-index: 999;\n  \n  .modal-content {\n    width: 80%;\n    background: #fff;\n    border-radius: 12rpx;\n    padding: 40rpx 30rpx;\n    \n    .modal-title {\n      text-align: center;\n      font-size: 32rpx;\n      font-weight: bold;\n      margin-bottom: 30rpx;\n    }\n    \n    .modal-links {\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      margin-bottom: 40rpx;\n      \n      .link {\n        color: #2a5fff;\n        font-size: 28rpx;\n        margin-bottom: 10rpx;\n      }\n    }\n    \n    .modal-buttons {\n      display: flex;\n      justify-content: space-between;\n      \n      button {\n        flex: 1;\n        height: 80rpx;\n        line-height: 80rpx;\n        font-size: 28rpx;\n        border-radius: 40rpx;\n      }\n      \n      .cancel-btn {\n        background: #f5f5f5;\n        color: #666;\n        margin-right: 20rpx;\n      }\n      \n      .confirm-btn {\n        background: #07c160;\n        color: #fff;\n      }\n    }\n  }\n}\n</style>","import MiniProgramPage from 'D:/CODE/capstone-project/club-master/club/club_uniapp/pages/user/login.vue'\nwx.createPage(MiniProgramPage)"],"names":["getCurrentInstance","ref","uni","setUser","wsClient","apiModule"],"mappings":";;;;;;;;;AA0CA,UAAM,EAAE,MAAO,IAAGA,iCAAoB;AACtC,UAAM,gBAAgBC,cAAG,IAAC,KAAK;AAC/B,UAAM,YAAYA,cAAG,IAAC,KAAK;AAG3B,aAAS,iBAAiB;AACxB,UAAI,CAAC,cAAc,OAAO;AACxBC,sBAAG,MAAC,UAAU,EAAE,OAAO,UAAU,MAAM,QAAQ;AAC/C;AAAA,MACD;AACD,gBAAU,QAAQ;AAAA,IACpB;AAGA,aAAS,cAAc;AACrB,gBAAU,QAAQ;AAAA,IACpB;AAGA,mBAAe,eAAe;AAC5B,gBAAU,QAAQ;AAClB,UAAI;AAEF,cAAM,cAAc,MAAM,IAAI,QAAQ,CAAC,SAAS,WAAW;AACzDA,wBAAAA,MAAI,MAAM;AAAA,YACR,SAAS,CAAC,QAAQ;AAChB,sBAAQ,GAAG;AAAA,YACZ;AAAA,YACD,MAAM,CAAC,QAAQ;AACb,qBAAO,GAAG;AAAA,YACX;AAAA,UACT,CAAO;AAAA,QACP,CAAK;AAGD,YAAI,eAAe,YAAY,MAAM;AACnCA,wBAAY,MAAA,MAAA,OAAA,8BAAA,aAAa,YAAY,IAAI;AACzC,gBAAM,MAAM,MAAM,MAAM,KAAK,KAAK,QAAQ,YAAY,IAAI;AAE1D,cAAI,IAAI,SAAS,KAAK;AAEpBA,0BAAAA,MAAI,eAAe,SAAS,IAAI,KAAK,KAAK;AAE1CC,uBAAO,QAAC,IAAI,IAAI;AAGhBD,0BAAAA,MAAA,MAAA,OAAA,8BAAY,qBAAqB;AACjCE,4BAAAA,SAAS,QAAQC,kBAAU,WAAW,uBAAuB;AAG7DH,0BAAAA,MAAI,UAAU;AAAA,cACZ,OAAO;AAAA,cACP,MAAM;AAAA,YAChB,CAAS;AAGD,uBAAW,MAAM;AACfA,4BAAAA,MAAI,SAAS,EAAE,KAAK,mBAAkB,CAAE;AAAA,YACzC,GAAE,IAAI;AAAA,UACR;AAAA,QACP,OAAW;AACL,gBAAM,IAAI,MAAM,UAAU;AAAA,QAC3B;AAAA,MACF,SAAQ,OAAO;AACdA,sBAAAA,MAAc,MAAA,SAAA,+BAAA,QAAQ,KAAK;AAC3BA,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO;AAAA,UACP,MAAM;AAAA,QACZ,CAAK;AAAA,MACF;AAAA,IACH;AAGA,mBAAe,aAAa;AAC1B,UAAI,CAAC,cAAc,OAAO;AACxBA,sBAAG,MAAC,UAAU,EAAE,OAAO,UAAU,MAAM,QAAQ;AAC/C;AAAA,MACD;AAID,YAAM,MAAM,MAAM,MAAM,KAAK,KAAK,QAAQ,YAAY;AACtDA,oBAAAA,MAAY,MAAA,OAAA,+BAAA,IAAI,IAAI;AACpB,UAAI,IAAI,SAAS,KAAK;AAEpBA,sBAAAA,MAAI,eAAe,SAAS,IAAI,KAAK,KAAK;AAE1CC,mBAAO,QAAC,IAAI,IAAI;AAGhBD,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO;AAAA,UACP,MAAM;AAAA,QACZ,CAAK;AAGD,mBAAW,MAAM;AACfA,wBAAAA,MAAI,SAAS,EAAE,KAAK,mBAAkB,CAAE;AAAA,QACzC,GAAE,IAAI;AAAA,MACR;AAAA,IACH;;;;;;;;;;;;;;;;;;AC7IA,GAAG,WAAW,eAAe;"}