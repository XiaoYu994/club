{"version":3,"file":"edit.js","sources":["pages/activity/edit.vue","../../../../../Software/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvYWN0aXZpdHkvZWRpdC52dWU"],"sourcesContent":["<!-- pages/activity/edit.vue -->\n<template>\n    <view class=\"edit-activity-container pageBg\">\n      <!-- 状态栏 -->\n      <view class=\"status-bar\" :style=\"{ height: statusBarHeight + 'px' }\"></view>\n      \n      <!-- 顶部导航 -->\n      <!-- #ifndef MP-TOUTIAO -->\n      <custom-nav-bar :title=\"isEdit ? '编辑活动' : '创建活动'\" :showBack=\"true\" @backClick=\"goBack\"></custom-nav-bar>\n      <!-- #endif -->\n      \n      <!-- 活动表单 -->\n      <activity-form \n        :activity-data=\"activityData\" \n        :is-edit=\"isEdit\"\n        :club-id=\"clubId\"\n        @cancel=\"goBack\"\n        @submit=\"handleSubmit\"\n      ></activity-form>\n    </view>\n  </template>\n  \n  <script setup>\n  import { ref, onMounted, getCurrentInstance } from 'vue';\n  import ActivityForm from '@/components/activity-form/activity-form.vue';\n  import { notifyActivityDataChanged } from '@/utils/activity.js';\n  \n  const { proxy } = getCurrentInstance();\n  \n  // 状态栏高度\n  const statusBarHeight = ref(20);\n  \n  // 活动数据\n  const activityData = ref({});\n  \n  // 是否为编辑模式\n  const isEdit = ref(false);\n  \n  // 社团ID\n  const clubId = ref('');\n  \n  // 初始化\n  onMounted(() => {\n    // 获取状态栏高度\n    statusBarHeight.value = uni.getSystemInfoSync().statusBarHeight || 20;\n    \n    // 获取页面参数\n    const pages = getCurrentPages();\n    const currentPage = pages[pages.length - 1];\n    const options = currentPage.options || {};\n    \n    // 获取活动ID和社团ID\n    const activityId = options.id;\n    clubId.value = options.clubId || '';\n    \n    // 判断是否为编辑模式\n    isEdit.value = !!activityId;\n    \n    // 如果是编辑模式，加载活动数据\n    if (isEdit.value) {\n      loadActivityData(activityId);\n    }\n  });\n  \n  // 加载活动数据\n  const loadActivityData = async (id) => {\n    try {\n      uni.showLoading({ title: '加载中...' });\n      \n      const res = await proxy.$api.activity.getActivityDetail(id);\n      \n      if (res.code === 200) {\n        activityData.value = res.data;\n        \n        // 如果没有传入社团ID，从活动数据中获取\n        if (!clubId.value && activityData.value.clubId) {\n          clubId.value = activityData.value.clubId;\n        }\n      } else {\n        uni.showToast({\n          title: res.message || '加载失败',\n          icon: 'none'\n        });\n      }\n    } catch (error) {\n      uni.showToast({\n        title: '网络异常，请稍后重试',\n        icon: 'none'\n      });\n    } finally {\n      uni.hideLoading();\n    }\n  };\n  \n  // 处理表单提交\n  const handleSubmit = async (formData) => {\n    try {\n      uni.showLoading({ title: '提交中...' });\n      \n      // 确保表单数据完整\n      if (!formData.title || !formData.address || !formData.description) {\n        uni.hideLoading();\n        uni.showToast({\n          title: '请完善活动信息',\n          icon: 'none'\n        });\n        return;\n      }\n      \n      let res;\n      \n      try {\n        if (isEdit.value) {\n          // 编辑活动\r\n\t\t  formData.updateTime = Date.now()\n          res = await proxy.$api.activity.updateActivity(formData);\n        } else {\n          // 创建活动\r\n\t\t   formData.createTime = Date.now()\n          res = await proxy.$api.activity.createActivity(formData);\n        }\n      } catch (networkError) {\n        console.error('API请求失败:', networkError);\n        uni.hideLoading();\n        uni.showToast({\n          title: '网络异常，请检查网络连接后重试',\n          icon: 'none',\n          duration: 3000\n        });\n        return;\n      }\n      \n      if (res && (res.code === 200 || res.code === 0)) {\n        // 触发活动数据变化事件，通知列表页刷新\n        notifyActivityDataChanged();\n        \n        uni.showToast({\n          title: isEdit.value ? '编辑成功' : '创建成功',\n          icon: 'success'\n        });\n        \n        // 延迟返回，让用户看到成功提示，但减少延迟时间\n        setTimeout(() => {\n          // 获取活动ID\n          const activityId = isEdit.value ? formData.id : (res.data?.id || res.data);\n          \n          if (activityId) {\n            // 编辑成功后，直接跳转到活动详情页，使用redirectTo保留页面栈结构\n            uni.redirectTo({\n              url: `/pages/activity/activityDeatil?id=${activityId}&t=${Date.now()}`\n            });\n          } else if (clubId.value) {\n            // 如果没有活动ID但有社团ID，返回社团详情页\n            uni.redirectTo({\n              url: `/pages/club/detail?id=${clubId.value}`\n            });\n          } else {\n            // 否则返回活动列表页\n            uni.switchTab({\n              url: '/pages/activity/activity'\n            });\n          }\n        }, 800); // 减少延迟时间\n      } else {\n        uni.showToast({\n          title: res?.message || res?.msg || '提交失败，请稍后重试',\n          icon: 'none',\n          duration: 2000\n        });\n        console.error('提交失败:', res);\n      }\n    } catch (error) {\n      console.error('处理提交过程中发生错误:', error);\n      uni.showToast({\n        title: '操作异常，请稍后重试',\n        icon: 'none',\n        duration: 2000\n      });\n    } finally {\n      uni.hideLoading();\n    }\n  };\n  \n  // 返回上一页\n  const goBack = () => {\n    // 通知活动数据可能已变更\n    notifyActivityDataChanged();\n    \n    // 添加短暂延迟，确保通知事件被处理\n    setTimeout(() => {\n      uni.navigateBack();\n    }, 100);\n  };\n  </script>\n  \n  <style lang=\"scss\" scoped>\n  .edit-activity-container {\n    min-height: 100vh;\n  }\n  \n  .status-bar {\n    width: 100%;\n    background-color: #ffffff;\n  }\n  </style>","import MiniProgramPage from 'D:/CODE/capstone-project/club-master/club/club_uniapp/pages/activity/edit.vue'\nwx.createPage(MiniProgramPage)"],"names":["getCurrentInstance","ref","onMounted","uni","notifyActivityDataChanged"],"mappings":"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"}